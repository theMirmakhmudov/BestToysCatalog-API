name: üöÄ Toys Catalog CI/CD Pipeline

on:
  push:
    branches:
      - "**"
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-and-test:
    name: üß© Build & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: ‚ö° Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: üîß Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üßπ Lint with flake8 (soft fail)
        run: |
          pip install flake8
          flake8 app --max-line-length=120 --ignore=E203,W503,E501 || echo "‚ö†Ô∏è Lint warnings ignored"

      - name: üß™ Run tests
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ALG: ${{ secrets.JWT_ALG }}
        run: |
          pip install pytest pytest-asyncio httpx
          pytest -v --disable-warnings --maxfail=1


  deploy:
    name: üöÄ Deploy to Production Server
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üîë Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: üöÄ Deploy via SSH
        env:
          HOST: ${{ secrets.SERVER_HOST }}
          USER: ${{ secrets.SERVER_USER }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ALG: ${{ secrets.JWT_ALG }}
          ACCESS_TTL_SECONDS: ${{ secrets.ACCESS_TTL_SECONDS }}
          REFRESH_TTL_SECONDS: ${{ secrets.REFRESH_TTL_SECONDS }}
          APP_DEFAULT_LANG: ${{ secrets.APP_DEFAULT_LANG }}
          RATE_LIMIT_PUBLIC: ${{ secrets.RATE_LIMIT_PUBLIC }}
          RATE_LIMIT_AUTH: ${{ secrets.RATE_LIMIT_AUTH }}
          RATE_LIMIT_ADMIN: ${{ secrets.RATE_LIMIT_ADMIN }}
          INIT_ADMIN_EMAIL: ${{ secrets.INIT_ADMIN_EMAIL }}
          INIT_ADMIN_PHONE: ${{ secrets.INIT_ADMIN_PHONE }}
          INIT_ADMIN_PASSWORD: ${{ secrets.INIT_ADMIN_PASSWORD }}
          INIT_ADMIN_NAME: ${{ secrets.INIT_ADMIN_NAME }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_FROM_NAME: ${{ secrets.SMTP_FROM_NAME }}
          SMTP_TLS: ${{ secrets.SMTP_TLS }}
        run: |
          set -e
          echo "‚úÖ MAIN branch detected ‚Äî starting deploy..."

          # 1Ô∏è‚É£ Copy configs to server
          scp -o StrictHostKeyChecking=no deploy/toys_catalog.service $USER@$HOST:/tmp/toys_catalog.service
          scp -o StrictHostKeyChecking=no deploy/toys_catalog.nginx.conf $USER@$HOST:/tmp/toys_catalog.nginx.conf

          # 2Ô∏è‚É£ SSH into server
          ssh -o StrictHostKeyChecking=no $USER@$HOST <<'EOF'
          set -e

          echo "üì¶ Preparing /var/www/toys_catalog..."
          sudo mkdir -p /var/www/toys_catalog
          cd /var/www/toys_catalog

          echo "üì• Pulling latest code..."
          if [ -d .git ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            echo "‚ö†Ô∏è No git repo found ‚Äî cloning fresh..."
            git clone https://github.com/theMirmakhmudov/BestToysCatalog-API.git /var/www/toys_catalog
          fi

          echo "üß© Writing environment variables..."
          cat > /var/www/toys_catalog/.env <<EOT
          DATABASE_URL=${DATABASE_URL}
          JWT_SECRET=${JWT_SECRET}
          JWT_ALG=${JWT_ALG}
          ACCESS_TTL_SECONDS=${ACCESS_TTL_SECONDS}
          REFRESH_TTL_SECONDS=${REFRESH_TTL_SECONDS}
          APP_DEFAULT_LANG=${APP_DEFAULT_LANG}
          RATE_LIMIT_PUBLIC=${RATE_LIMIT_PUBLIC}
          RATE_LIMIT_AUTH=${RATE_LIMIT_AUTH}
          RATE_LIMIT_ADMIN=${RATE_LIMIT_ADMIN}
          INIT_ADMIN_EMAIL=${INIT_ADMIN_EMAIL}
          INIT_ADMIN_PHONE=${INIT_ADMIN_PHONE}
          INIT_ADMIN_PASSWORD=${INIT_ADMIN_PASSWORD}
          INIT_ADMIN_NAME=${INIT_ADMIN_NAME}
          SMTP_HOST=${SMTP_HOST}
          SMTP_PORT=${SMTP_PORT}
          SMTP_USERNAME=${SMTP_USERNAME}
          SMTP_PASSWORD=${SMTP_PASSWORD}
          SMTP_FROM=${SMTP_FROM}
          SMTP_FROM_NAME=${SMTP_FROM_NAME}
          SMTP_TLS=${SMTP_TLS}
          EOT

          echo "üêç Setting up virtual environment..."
          python3 -m venv .venv
          source .venv/bin/activate

          echo "üì¶ Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt

          echo "‚öôÔ∏è Installing systemd service..."
          sudo mv /tmp/toys_catalog.service /etc/systemd/system/toys_catalog.service
          sudo systemctl daemon-reload
          sudo systemctl enable toys_catalog.service

          echo "üåê Installing Nginx config..."
          sudo mv /tmp/toys_catalog.nginx.conf /etc/nginx/sites-available/toys_catalog.conf
          sudo ln -sf /etc/nginx/sites-available/toys_catalog.conf /etc/nginx/sites-enabled/toys_catalog.conf
          sudo nginx -t
          sudo systemctl reload nginx

          echo "‚ôªÔ∏è Restarting FastAPI service..."
          sudo systemctl restart toys_catalog.service || (sudo journalctl -u toys_catalog.service -n 40 --no-pager && exit 1)

          echo "‚è± Waiting 5s for health check..."
          sleep 5

          if systemctl is-active --quiet toys_catalog.service; then
            echo "‚úÖ Deploy successful and service active!"
          else
            echo "‚ùå Deploy failed ‚Äî service not running!"
            sudo journalctl -u toys_catalog.service -n 40 --no-pager
            exit 1
          fi
          EOF


  skip-deploy:
    name: üö´ Skip Deploy (Not Main Branch)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref != 'refs/heads/main'
    steps:
      - run: echo "‚ùå Not main branch. Only tests executed."