name: üöÄ Toys Catalog CI/CD Pipeline

on:
  push:
    branches:
      - "main"

permissions:
  contents: read

jobs:
  build-and-test:
    name: üß© Build & Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: toys_catalog_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: ‚ö° Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: üîß Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest pytest-asyncio httpx

      - name: üßπ Lint with flake8 (soft fail)
        run: |
          flake8 app --max-line-length=120 --ignore=E203,W503,E501 || echo "‚ö†Ô∏è Lint warnings ignored"

      - name: üîÑ Run database migrations
        env:
          DATABASE_URL: postgresql+psycopg://postgres:postgres@localhost:5432/toys_catalog_test
        run: |
          alembic upgrade head

      - name: üß™ Run tests
        env:
          DATABASE_URL: postgresql+psycopg://postgres:postgres@localhost:5432/toys_catalog_test
          APP_DEFAULT_LANG: uz
          RATE_LIMIT_PUBLIC: 30/minute
          RATE_LIMIT_AUTH: 120/minute
          RATE_LIMIT_ADMIN: 300/minute
          INIT_ADMIN_PHONE: +998900000001
          INIT_ADMIN_TELEGRAM_ID: 123456789
          INIT_ADMIN_NAME: Test Admin
          SECRET_KEY: test_secret_key_for_ci
        run: |
          pytest -v --tb=short

  deploy:
    name: üöÄ Deploy (Docker)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ÔøΩ Lowercase Repo Owner
        id: lowercase_owner
        run: |
          echo "OWNER_LC=${OWNER,,}" >>${GITHUB_ENV}
        env:
          OWNER: '${{ github.repository_owner }}'

      - name: ÔøΩüî® Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.OWNER_LC }}/toys_catalog_api:latest

      - name: üìù Prepare Docker Compose file
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|ghcr.io/${{ env.OWNER_LC }}/toys_catalog_api:latest|g" docker-compose.prod.yml

      - name: üîë Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: üöÄ Deploy to Production
        env:
          HOST: ${{ secrets.SERVER_HOST }}
          USER: ${{ secrets.SERVER_USER }}
          DOMAIN: ${{ secrets.DOMAIN }}
          SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
          # Postgres Database Credentials
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          # Env vars for the application
          DATABASE_URL: postgresql+psycopg://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          APP_DEFAULT_LANG: ${{ secrets.APP_DEFAULT_LANG }}
          RATE_LIMIT_PUBLIC: ${{ secrets.RATE_LIMIT_PUBLIC }}
          RATE_LIMIT_AUTH: ${{ secrets.RATE_LIMIT_AUTH }}
          RATE_LIMIT_ADMIN: ${{ secrets.RATE_LIMIT_ADMIN }}
          INIT_ADMIN_PHONE: ${{ secrets.INIT_ADMIN_PHONE }}
          INIT_ADMIN_TELEGRAM_ID: ${{ secrets.INIT_ADMIN_TELEGRAM_ID }}
          INIT_ADMIN_NAME: ${{ secrets.INIT_ADMIN_NAME }}
          # Docker Registry Auth for Server
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GH_USERNAME: ${{ github.actor }}
        run: |
          set -e
          echo "‚úÖ MAIN branch detected ‚Äî starting Docker deploy..."

          # Copy service file and docker-compose.prod.yml
          scp -o StrictHostKeyChecking=no deploy/toys_catalog.service $USER@$HOST:/tmp/toys_catalog.service
          scp -o StrictHostKeyChecking=no deploy/toys_catalog.nginx.conf $USER@$HOST:/tmp/toys_catalog.nginx.conf
          scp -o StrictHostKeyChecking=no docker-compose.prod.yml $USER@$HOST:/tmp/docker-compose.prod.yml

          ssh -o StrictHostKeyChecking=no $USER@$HOST <<EOF
          set -e
          echo "üì¶ Setting up directories..."
          sudo mkdir -p /var/www/toys_catalog
          sudo chown $USER:$USER /var/www/toys_catalog
          cd /var/www/toys_catalog

          echo "üê≥ Logging into GHCR..."
          echo "$GHCR_PAT" | docker login ghcr.io -u "$GH_USERNAME" --password-stdin

          echo "üìÑ Moving files..."
          mv /tmp/docker-compose.prod.yml ./docker-compose.prod.yml
          
          # Update systemd service
          sudo mv /tmp/toys_catalog.service /etc/systemd/system/toys_catalog.service
          sudo systemctl daemon-reload
          sudo systemctl enable toys_catalog.service

          echo "üß© Writing .env file..."
          cat > .env <<EOT
          # Postgres Database
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}
          # Application
          DATABASE_URL=${DATABASE_URL}
          SECRET_KEY=${SECRET_KEY}
          APP_DEFAULT_LANG=${APP_DEFAULT_LANG}
          RATE_LIMIT_PUBLIC=${RATE_LIMIT_PUBLIC}
          RATE_LIMIT_AUTH=${RATE_LIMIT_AUTH}
          RATE_LIMIT_ADMIN=${RATE_LIMIT_ADMIN}
          INIT_ADMIN_PHONE=${INIT_ADMIN_PHONE}
          INIT_ADMIN_TELEGRAM_ID=${INIT_ADMIN_TELEGRAM_ID}
          INIT_ADMIN_NAME=${INIT_ADMIN_NAME}
          EOT

          echo "üîÑ Pulling latest images..."
          docker compose -f docker-compose.prod.yml pull
          
          echo "üöÄ Restarting services..."
          # We use systemctl to restart, which runs docker compose up
          sudo systemctl restart toys_catalog.service

          echo "üåê Configuring Nginx..."
          sudo apt update -y
          sudo apt install -y nginx certbot python3-certbot-nginx
          sudo mv /tmp/toys_catalog.nginx.conf /etc/nginx/sites-available/toys_catalog.conf
          sudo ln -sf /etc/nginx/sites-available/toys_catalog.conf /etc/nginx/sites-enabled/toys_catalog.conf
          sudo nginx -t
          sudo systemctl reload nginx

          echo "üîí Setting up SSL with Let's Encrypt..."
          sudo certbot --nginx -d ${DOMAIN} --non-interactive --agree-tos -m ${SSL_EMAIL} || echo "‚ö†Ô∏è SSL setup skipped or failed"

          echo "‚ôªÔ∏è Restarting services..."
          sudo systemctl restart nginx
          sudo systemctl restart toys_catalog.service

          echo "‚úÖ Docker Deployment completed!"
          EOF